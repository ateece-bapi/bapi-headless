name: Lighthouse CI

on:
  pull_request:
    branches: [main]
    paths:
      - 'web/src/**'
      - 'web/public/**'
      - 'web/next.config.ts'
      - 'web/package.json'

jobs:
  lighthouse:
    name: Run Lighthouse CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./web
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: './web/pnpm-lock.yaml'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build application
        run: pnpm run build
        env:
          NEXT_PUBLIC_WORDPRESS_GRAPHQL: ${{ secrets.NEXT_PUBLIC_WORDPRESS_GRAPHQL }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      
      - name: Run Lighthouse CI
        run: |
          pnpm run lighthouse
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: web/.lighthouseci
          retention-days: 30
      
      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              // Read Lighthouse results from manifest
              const resultsPath = path.join(process.env.GITHUB_WORKSPACE, 'web/.lighthouseci');
              const manifestPath = path.join(resultsPath, 'manifest.json');
              
              if (!fs.existsSync(manifestPath)) {
                console.log('No Lighthouse results found');
                return;
              }
              
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              const firstRun = manifest[0]?.jsonPath;
              
              if (!firstRun) {
                console.log('No run data in manifest');
                return;
              }
              
              const lhr = JSON.parse(fs.readFileSync(path.join(resultsPath, path.basename(firstRun)), 'utf8'));
              
              // Extract scores (0-1 scale, convert to 0-100)
              const scores = {
                performance: Math.round(lhr.categories.performance.score * 100),
                accessibility: Math.round(lhr.categories.accessibility.score * 100),
                bestPractices: Math.round(lhr.categories['best-practices'].score * 100),
                seo: Math.round(lhr.categories.seo.score * 100),
              };
              
              // Extract Core Web Vitals
              const metrics = {
                lcp: Math.round(lhr.audits['largest-contentful-paint'].numericValue),
                cls: lhr.audits['cumulative-layout-shift'].numericValue.toFixed(3),
                tbt: Math.round(lhr.audits['total-blocking-time'].numericValue),
                fcp: Math.round(lhr.audits['first-contentful-paint'].numericValue),
                si: Math.round(lhr.audits['speed-index'].numericValue),
              };
              
              // Helper function for status emoji
              const getEmoji = (score) => score >= 90 ? 'âœ…' : score >= 50 ? 'âš ï¸' : 'âŒ';
              const getCWVEmoji = (metric, value) => {
                if (metric === 'lcp') return value < 2500 ? 'âœ…' : value < 4000 ? 'âš ï¸' : 'âŒ';
                if (metric === 'cls') return value < 0.1 ? 'âœ…' : value < 0.25 ? 'âš ï¸' : 'âŒ';
                if (metric === 'tbt') return value < 300 ? 'âœ…' : value < 600 ? 'âš ï¸' : 'âŒ';
                return 'ðŸ“Š';
              };
              
              const comment = `## ðŸ” Lighthouse CI Results
              
**Scores:**
${getEmoji(scores.performance)} Performance: **${scores.performance}** / 100
${getEmoji(scores.accessibility)} Accessibility: **${scores.accessibility}** / 100
${getEmoji(scores.bestPractices)} Best Practices: **${scores.bestPractices}** / 100
${getEmoji(scores.seo)} SEO: **${scores.seo}** / 100

**Core Web Vitals:**
${getCWVEmoji('lcp', metrics.lcp)} LCP (Largest Contentful Paint): **${metrics.lcp}ms** (target: <2.5s)
${getCWVEmoji('cls', metrics.cls)} CLS (Cumulative Layout Shift): **${metrics.cls}** (target: <0.1)
${getCWVEmoji('tbt', metrics.tbt)} TBT (Total Blocking Time): **${metrics.tbt}ms** (target: <300ms)

**Other Metrics:**
- FCP (First Contentful Paint): **${metrics.fcp}ms** (target: <1.8s)
- Speed Index: **${metrics.si}ms** (target: <3.0s)

**Thresholds:**
- âœ… Performance: 90+ required
- âœ… Accessibility: 95+ required
- âœ… Best Practices: 90+ required
- âœ… SEO: 95+ required

ðŸ“Š [View detailed report in artifacts](${context.payload.pull_request.html_url}/checks)

---
*Lighthouse v${lhr.lighthouseVersion} â€¢ Powered by [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci)*`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              // Fail workflow if critical thresholds not met
              if (scores.performance < 90 || scores.accessibility < 95 || scores.seo < 95) {
                core.setFailed(`Lighthouse scores below threshold. Performance: ${scores.performance}, Accessibility: ${scores.accessibility}, SEO: ${scores.seo}`);
              }
              
            } catch (error) {
              console.error('Error processing Lighthouse results:', error);
              
              // Fallback comment
              const fallbackComment = `## ðŸ” Lighthouse CI Results
              
Lighthouse tests completed. View detailed results in the [workflow artifacts](${context.payload.pull_request.html_url}/checks).

**Thresholds:**
- âœ… Performance: 90+
- âœ… Accessibility: 95+
- âœ… Best Practices: 90+
- âœ… SEO: 95+`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackComment
              });
            }
