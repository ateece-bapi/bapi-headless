# FileMaker Order Upload Fix - Documentation

**Date:** January 7-8, 2026  
**Issue:** WooCommerce checkout failure - orders not uploading to FileMaker  
**Status:** Emergency fix deployed, manual process working, permanent fix pending

---

## Problem Summary

### Initial Symptom
- Customers unable to complete checkout on www.bapihvac.com
- Error message: "Could not connect to ftp server 68.65.44.99 on port 21"
- Revenue loss - checkout completely broken

### Root Cause
- IT department switched from FTP (port 21) to SFTP (port 22) approximately 2 months ago
- Change was made for security after brute force attack
- WordPress code still using old FTP connection
- Orders saved to WordPress but not transferred to FileMaker for fulfillment

---

## Solutions Implemented

### Phase 1: Emergency Fix (COMPLETED - January 7, 2026)

**Goal:** Restore checkout immediately to prevent further revenue loss

**Action Taken:**
1. Modified `/wp-content/themes/bapi-v4/.config/.env.local` on PRODUCTION server
2. Cleared all FTP credentials (set to empty values):
   ```env
   BAPI_FTP_HOST_ORDERS=
   BAPI_FTP_USER_ORDERS=
   BAPI_FTP_PASS_ORDERS=
   BAPI_FTP_PORT_ORDERS=21
   ```
3. This forces FTP connection to fail gracefully without blocking checkout

**Result:**
- ‚úÖ Checkout working - co-worker confirmed "Order Received" message displays
- ‚úÖ Orders saved to WordPress successfully
- ‚úÖ `.mer` files still generated in `/wp-content/uploads/order_csv/`
- ‚ö†Ô∏è Orders NOT automatically uploaded to FileMaker (requires manual upload)

**Files Modified:**
- Production: `/wp-content/themes/bapi-v4/.config/.env.local`

---

### Phase 2: Manual Upload Process (COMPLETED - January 8, 2026)

**Goal:** Establish interim process to upload orders to FileMaker daily

#### Setup Completed:

1. **WinSCP Installation:**
   - Downloaded and installed from https://winscp.net
   - SFTP client for file transfers

2. **Network Access:**
   - IT whitelisted public IP: `23.87.88.182`
   - IT created port forward: External `207.190.107.107:22` ‚Üí Internal `68.65.44.99:22222`
   - Connection confirmed working

3. **SFTP Connection Details:**
   - **Host:** `207.190.107.107`
   - **Port:** `22`
   - **Protocol:** SFTP
   - **Username:** `bapiws`
   - **Password:** `$ub@ruLEGOsho3B0x!`
   - **SSH Key:** `bapiws-private.ppk` (optional, password works)
   - **Upload Directory:** `/` (root directory of SFTP server)

4. **Test Upload:**
   - ‚úÖ Uploaded 6 orders from January 7, 2026
   - ‚úÖ IT confirmed files received
   - ‚úÖ FileMaker middleware detected files and ran import script automatically
   - ‚úÖ Process validated end-to-end

#### Daily Manual Process:

**Frequency:** Once per day (recommend morning)  
**Time Required:** ~5 minutes  
**Tools:** WinSCP, WordPress WP File Manager

**Steps:**

1. **Download orders from WordPress:**
   - Go to WordPress Admin: https://www.bapihvac.com/wp-admin
   - Navigate to: **WP File Manager** (in sidebar)
   - Browse to: `/wp-content/uploads/order_csv/`
   - Look for new `.mer` files with today's date (format: `order__YYYYMMDD_ORDERID.mer`)
   - Select all new files
   - Download to local computer (e.g., Downloads folder)

2. **Upload to FileMaker server:**
   - Open **WinSCP**
   - Connect to saved "FileMaker Server" session (credentials above)
   - In left panel (local): Navigate to Downloads folder
   - In right panel (remote): Verify you're in `/` root directory
   - Select all downloaded `.mer` files
   - Drag to right panel OR click **Upload** button
   - Wait for transfer to complete

3. **Verify upload:**
   - Check with IT or Customer Service to confirm orders appear in FileMaker
   - FileMaker middleware should auto-process files within seconds

**Notes:**
- `.mer` files are automatically generated by WordPress after each order
- Each file contains ONE order in CSV format
- FileMaker middleware monitors the upload directory and auto-imports
- Files are removed by middleware after successful import

---

## Technical Details

### Architecture

```
Customer Checkout (WooCommerce)
    ‚Üì
WordPress Order Processing
    ‚Üì
Generate .mer file (CSV format)
    ‚Üì
Save to: /wp-content/uploads/order_csv/
    ‚Üì
[MANUAL] Download via WP File Manager
    ‚Üì
[MANUAL] Upload via WinSCP to FileMaker SFTP server
    ‚Üì
FileMaker Middleware detects file
    ‚Üì
Import to FileMaker database
    ‚Üì
Order fulfillment process begins
```

### File Format: .mer Files

**What it is:**
- Custom CSV file format with `.mer` extension
- "MER" likely stands for "merchant" or "merchandise"
- One file per order

**Filename Pattern:**
```
order__YYYYMMDD_ORDERID.mer
```
Example: `order__20260107_422260.mer`

**Content Structure:**
```csv
WebStoreOrderID,OrderFileName,SalesTax,CustomerOrderNo,DateOrderEntered,NotesFromBuyer,PartialsAccepted,FlagPayByCreditCard,BillToID,BillToCompanyName,BuyerName,DealerID,ShipToID,ShipToCompanyName,DateDesiredToShip,FlagMultipleShipDates,FlagShipPrepaid,FlagShipBillRecipient,FlagShipBillThirdParty,FreightAcct,ShippingMethod,ShipToAddress01,ShipToAddress02,ShipToCity,ShipToState,ShipToPostalCode,ShipToCountry,ShipToAttn,LineItem01,ProductName01,QtyOrdered01,NetUnitPrice01,LineItemTotal01,OrderMerchTotal,
422260,order__20260107_422260.mer,0,,01/07/2026,,,0,,Multitel, ,,,COX COMMUNICATIONS,,0,1,0,0,, UPS,1550 W. DEER VALLEY,,PHOENIX,AZ,85027,US,THAD LEHMAN,1,BA/APSW1,1,,25,25,
```

**Key Fields:**
- Order ID
- Order date
- Customer information (billing/shipping)
- Line items (product SKU, quantity, price)
- Totals
- Shipping method

### WordPress Code Structure

**Theme Location:**
`/wp-content/themes/bapi-v4/`

**Key Files:**
1. `functions.php` (line 595+)
   - Contains `ftp_file()` function
   - Uses PHP's `ftp_connect()`, `ftp_login()`, `ftp_put()`
   - Currently disabled (FTP credentials cleared)

2. `src/Vendi/BAPI/Theme/Utility/FtpCredentialUtility.php`
   - Retrieves FTP credentials from environment variables
   - Method: `getCredentialsForOrders()`

3. `.config/.env.local`
   - Stores FTP/SFTP credentials
   - Currently has empty values (emergency fix)

**How it works:**
1. WooCommerce fires `woocommerce_payment_complete` hook after successful payment
2. Custom code generates `.mer` CSV file from order data
3. File saved to `/wp-content/uploads/order_csv/`
4. `ftp_file()` function called to upload file
5. Currently fails gracefully (empty credentials) allowing checkout to complete

---

## Server Information

### Production WordPress Server

**Site:** www.bapihvac.com  
**Server:** prod-2025.bapihvac.com  
**IP Address:** `104.248.14.80`  
**Provider:** DigitalOcean (NYC3)  
**Management:** SpinupWP  
**OS:** Ubuntu 24.04 LTS  
**PHP:** 8.2  
**MySQL:** 8.4

**SSH Access:**
- Username: `bapihvac`
- Authentication: Public key (StageDev key)
- Via SpinupWP dashboard

### Staging WordPress Server

**Site:** bapi-stage.vendi.dev / stage-2025.bapihvac.com  
**IP Address:** `138.197.74.68`  
**Provider:** DigitalOcean  
**Management:** SpinupWP

### FileMaker Server

**Original IP (Internal):** `68.65.44.99`  
**External Access IP:** `207.190.107.107`  
**Port:** `22` (external) ‚Üí `22222` (internal via port forward)  
**Protocol:** SFTP (SSH File Transfer Protocol)

**Credentials:**
- **Orders Account (use this):**
  - Username: `bapiws`
  - Password: `$ub@ruLEGOsho3B0x!`
  - SSH Key: `bapiws-private.ppk` (PuTTY format)

- **WAM Account (alternative):**
  - Username: `bapiukws`
  - Password: `theGR3@tBolivianW!NT3r!`
  - SSH Key: `bapiukws-private.ppk` (PuTTY format)

**Upload Path:** `/` (root directory of SFTP user)  
**FileMaker Processing:** Automatic middleware monitors upload directory

---

## Phase 3: Permanent SFTP Fix (PENDING)

**Goal:** Automate order uploads from WordPress to FileMaker via SFTP

**Timeline:** 2-3 days  
**Status:** Not started - waiting for backlog orders confirmation

### Implementation Plan

#### Day 1: Development on Staging Server

1. **Install phpseclib library:**
   ```bash
   cd /home/bapihvac/sites/stage-2025.bapihvac.com/public_html
   composer require phpseclib/phpseclib
   ```

2. **Rewrite `ftp_file()` function:**
   - Location: `/wp-content/themes/bapi-v4/functions.php`
   - Replace `ftp_connect()` with `phpseclib\Net\SFTP`
   - Add SSH key authentication support
   - Maintain error handling and logging

3. **Update `.env.local` on staging:**
   ```env
   BAPI_FTP_HOST_ORDERS=207.190.107.107
   BAPI_FTP_USER_ORDERS=bapiws
   BAPI_FTP_PASS_ORDERS=$ub@ruLEGOsho3B0x!
   BAPI_FTP_PORT_ORDERS=22
   ```

4. **Test with IT coordination:**
   - Place test order on staging
   - Verify `.mer` file created
   - Confirm SFTP upload successful
   - IT verifies file received in FileMaker

#### Day 2: Testing & Debugging

1. **End-to-end testing:**
   - Multiple test orders on staging
   - Verify all order types (simple, variable products)
   - Test error scenarios (network timeout, bad credentials)
   - Confirm FileMaker imports correctly

2. **Code review:**
   - Verify error handling
   - Check logging configuration
   - Validate credentials security
   - Test failover scenarios

3. **Documentation:**
   - Update code comments
   - Document new SFTP process
   - Create rollback plan

#### Day 3: Production Deployment

1. **Backup production:**
   - Full WordPress backup via SpinupWP
   - Database snapshot
   - Theme files backup

2. **Deploy code changes:**
   - Upload modified `functions.php`
   - Update `.env.local` with SFTP credentials
   - Deploy phpseclib library

3. **Update production `.env.local`:**
   ```env
   BAPI_FTP_HOST_ORDERS=207.190.107.107
   BAPI_FTP_USER_ORDERS=bapiws
   BAPI_FTP_PASS_ORDERS=$ub@ruLEGOsho3B0x!
   BAPI_FTP_PORT_ORDERS=22
   ```

4. **Monitoring:**
   - Watch for first real order
   - Verify automated upload
   - IT confirms FileMaker receives file
   - Monitor error logs for 24 hours

5. **Validation:**
   - Customer Service confirms orders appearing in FileMaker
   - No checkout errors reported
   - End manual upload process

### Code Changes Preview

**Current FTP code (functions.php, line ~630):**
```php
$conn_id = ftp_connect($ftp_credentials->host, $ftp_credentials->port, 10);
if (!$conn_id) {
    throw new FtpConnectionException($ftp_credentials);
}

if (!ftp_login($conn_id, $ftp_credentials->user, $ftp_credentials->getPassword())) {
    throw new FtpLoginException($ftp_credentials, $error);
}

ftp_pasv($conn_id, true);
ftp_put($conn_id, $ftp_web_root . $filename, $file, FTP_BINARY);
ftp_close($conn_id);
```

**New SFTP code (to be implemented):**
```php
use phpseclib\Net\SFTP;

$sftp = new SFTP($ftp_credentials->host, $ftp_credentials->port);
if (!$sftp->login($ftp_credentials->user, $ftp_credentials->getPassword())) {
    throw new FtpLoginException($ftp_credentials, 'SFTP login failed');
}

$remote_file = '/' . $filename; // Root directory
if (!$sftp->put($remote_file, $file, SFTP::SOURCE_LOCAL_FILE)) {
    throw new Exception('SFTP upload failed');
}
```

---

## Python Script Alternative

**Location:** `/home/ateece/bapi-headless/scripts/upload-orders-to-filemaker.py`

**Purpose:** Automate manual upload process (alternative to WinSCP)

**Usage:**
```bash
# Upload today's orders
python upload-orders-to-filemaker.py

# Upload specific date
python upload-orders-to-filemaker.py --date 2026-01-07

# Specify custom folder
python upload-orders-to-filemaker.py --folder /path/to/mer/files
```

**Requirements:**
```bash
pip install paramiko
```

**Configuration:**
Edit script to set local folder where `.mer` files are downloaded from WordPress.

**When to use:**
- Bulk uploading many orders (100+)
- Automating daily uploads from command line
- Scheduled uploads via cron job

---

## Troubleshooting

### Checkout Still Failing

**Symptom:** Customers see error during checkout

**Checks:**
1. Verify `.env.local` has empty FTP credentials on production
2. Clear WordPress cache (WP Super Cache, W3 Total Cache, etc.)
3. Check PHP error logs in WP Admin ‚Üí Tools ‚Üí Site Health ‚Üí Info
4. Verify WooCommerce order was created (Orders page)

**Solution:**
If FTP error still appears, temporarily disable hook:
- Edit `functions.php`
- Comment out line that calls `ftp_file()`

### SFTP Connection Timeout

**Symptom:** WinSCP or Python script cannot connect to FileMaker server

**Checks:**
1. Verify public IP hasn't changed: https://whatismyipaddress.com
2. Contact IT to re-whitelist new IP
3. Try alternate IP if on VPN or different network
4. Verify FileMaker server is running (ask IT)

### Files Not Appearing in FileMaker

**Symptom:** Uploads complete but orders missing from FileMaker

**Checks:**
1. Ask IT if middleware service is running
2. Verify files uploaded to correct directory (`/` root)
3. Check file permissions (should be readable by middleware)
4. Ask IT to check middleware error logs
5. Verify `.mer` file format is correct (open in text editor)

### Missing Orders from Past

**Symptom:** Customer Service reports orders never received

**Solution:**
1. Check WordPress `/wp-content/uploads/order_csv/` for backlog
2. Download all `.mer` files from missing date range
3. Bulk upload via WinSCP (select all, drag to upload)
4. Or use Python script with date range
5. Coordinate with IT to verify FileMaker receives all files

---

## Contact Information

### IT Department
- **Network/Firewall:** Port forwarding, IP whitelisting
- **FileMaker Server:** Middleware status, error logs, file verification
- **SSH Keys:** Passphrases, access credentials

### Customer Service
- **Missing Orders:** Which dates need backlog uploaded
- **FileMaker Status:** Confirm orders appearing correctly
- **Order Numbers:** Specific orders to investigate

### SpinupWP Support
- **Server Access:** SSH keys, site user credentials
- **Backups:** Restore points before deployment
- **Server Issues:** PHP errors, disk space, permissions

---

## Timeline Summary

### January 7, 2026 (Tuesday)
- üî¥ **Issue discovered:** Checkout broken with FTP error
- üîç **Investigation:** Located FTP config in `.env.local` file
- üí° **Root cause identified:** IT switched FTP‚ÜíSFTP 2 months ago
- ‚ö° **Emergency fix deployed:** Cleared FTP credentials
- ‚úÖ **Checkout restored:** Co-worker confirmed working
- üìã **Decision:** Implement permanent SFTP fix (2-3 days)

### January 8, 2026 (Wednesday)
- üîß **IT coordination:** New FileMaker IP provided (207.190.107.107)
- üåê **Network access:** Public IP whitelisted (23.87.88.182)
- üì¶ **WinSCP setup:** SFTP connection established
- ‚úÖ **Test upload:** 6 orders from 01/07 uploaded successfully
- ‚úÖ **IT verification:** FileMaker middleware processed files
- üìù **Documentation:** Completed comprehensive guide
- ‚è≥ **Pending:** Customer Service confirmation on backlog dates

### Next Steps
- üìä Customer Service: Identify missing order date ranges
- üì§ Bulk upload: Upload any backlog orders
- üíª Development: Start permanent SFTP fix on staging (Day 1)
- üß™ Testing: Validate SFTP automation (Day 2)
- üöÄ Deployment: Push to production (Day 3)

---

## Files & Resources

### Key WordPress Files
- `/wp-content/themes/bapi-v4/functions.php` - FTP upload function
- `/wp-content/themes/bapi-v4/.config/.env.local` - FTP credentials
- `/wp-content/themes/bapi-v4/src/Vendi/BAPI/Theme/Utility/FtpCredentialUtility.php`
- `/wp-content/uploads/order_csv/` - Generated .mer files

### Documentation Files
- `/home/ateece/bapi-headless/docs/FILEMAKER-ORDER-UPLOAD-FIX.md` - This document
- `/home/ateece/bapi-headless/scripts/upload-orders-to-filemaker.py` - Python upload script

### External Resources
- WinSCP Download: https://winscp.net
- phpseclib Documentation: https://phpseclib.com
- WooCommerce Hooks: https://woocommerce.github.io/code-reference/hooks/hooks.html

---

## Success Criteria

### Emergency Fix ‚úÖ
- [x] Checkout functional for customers
- [x] Orders saved to WordPress database
- [x] .mer files generated correctly
- [x] No revenue loss

### Manual Process ‚úÖ
- [x] WinSCP connection working
- [x] Files successfully upload to FileMaker
- [x] IT confirms middleware processing
- [x] Test orders verified end-to-end
- [x] Documentation complete

### Permanent Fix (Pending)
- [ ] phpseclib library installed on staging
- [ ] SFTP code rewritten and tested
- [ ] Staging validation complete
- [ ] Production deployment successful
- [ ] Automated uploads confirmed working
- [ ] Manual process no longer needed
- [ ] IT sign-off received

---

## Notes

- Headless Next.js site launches **April 2026** (3 months)
- Despite timeline, management chose permanent fix over manual process
- Avoid 3 months of daily manual uploads (5 min/day = 7.5 hours total)
- Learning opportunity for SFTP integration patterns
- May inform headless site architecture decisions

---

**Document maintained by:** Andrew Teece  
**Last updated:** January 8, 2026  
**Next review:** After permanent fix deployment
